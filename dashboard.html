<!DOCTYPE html>
<html>
<head>
<title>Linkarsha Studio</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;background:#f6f7fb;}
.header{padding:20px 40px;font-weight:700;font-size:20px;background:white;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
.container{display:flex;gap:40px;padding:40px;flex-wrap:wrap;}
.left,.right{background:white;border-radius:20px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,0.06);}
.left{width:340px;}
.right{flex:1;min-width:300px;}

.previewCard{border-radius:25px;padding:25px;text-align:center;background:#fff;}
.avatar{width:70px;height:70px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:26px;margin:auto;margin-bottom:10px;background:#6366f1;color:white;background-size:cover;background-position:center;}
.linkbtn{display:block;padding:12px;margin:8px 0;border-radius:12px;text-decoration:none;font-weight:600;background:white;color:#111;box-shadow:0 5px 15px rgba(0,0,0,0.05);}
.featured{background:linear-gradient(135deg,#7c3aed,#6366f1);color:white;}

.statBox{background:linear-gradient(135deg,#6366f1,#4f46e5);color:white;padding:12px;border-radius:12px;margin-bottom:8px;font-weight:600;}

.sectionTitle{font-weight:700;margin-top:18px;margin-bottom:8px;}
input,select{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #eee;}
button{padding:8px 12px;border:none;border-radius:8px;background:#6366f1;color:white;font-weight:600;cursor:pointer;margin-top:6px;}

.linkRow{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;margin:6px 0;background:#fafafa;cursor:grab;}
.dragging{opacity:0.4;}
</style>
</head>

<body>

<div class="header">Linkarsha Studio</div>

<div class="container">

<div class="left">
<div class="previewCard" id="previewCard">
<div class="avatar" id="avatar">U</div>
<div id="previewUsername">@username</div>
<div id="previewBio" style="margin:6px 0;color:#666"></div>
<div id="previewLinks"></div>
</div>
</div>

<div class="right">

<div class="sectionTitle">Analytics</div>
<div class="statBox" id="viewStat">üëÅ 0 Views</div>
<div id="clickStats"></div>

<div class="sectionTitle">Profile</div>
<input id="bioInput" placeholder="Write bio">
<button onclick="saveBio()">Save Bio</button>

<div class="sectionTitle">Add Link</div>
<input id="title" placeholder="Instagram / YouTube">
<input id="url" placeholder="https://">
<button onclick="addLink()">Add Link</button>

<div class="sectionTitle">Your Links (Drag to reorder)</div>
<div id="linksList"></div>

<div class="sectionTitle">Design</div>
<label>Background</label>
<input type="color" id="bgColor">
<label>Text</label>
<input type="color" id="textColor">
<label>Button</label>
<input type="color" id="btnColor">
<select id="fontSelect">
<option value="default">Default</option>
<option value="serif">Serif</option>
<option value="mono">Mono</option>
<option value="modern">Modern</option>
</select>
<button onclick="saveDesign()">Save Design</button>

</div>
</div>

<script>
const { createClient } = supabase;
const supabaseClient=createClient(
"https://pibrvhziqkaitaacbegy.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBpYnJ2aHppcWthaXRhYWNiZWd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0Mzc3MDQsImV4cCI6MjA4NzAxMzcwNH0.gBi73cyS6exLNfm1iz6IwAzWFXXxFAjgjlnbuHx7HMw"
);

let userId=null;
let linksData=[];

async function load(){
const {data:{user}}=await supabaseClient.auth.getUser();
if(!user){location.href="/";return;}
userId=user.id;

const {data:profile}=await supabaseClient.from("profiles").select("*").eq("id",userId).single();

document.getElementById("previewUsername").innerText="@"+profile.username;
document.getElementById("previewBio").innerText=profile.bio||"";
document.getElementById("viewStat").innerText="üëÅ "+(profile.views||0)+" Views";

if(profile.avatar){
document.getElementById("avatar").style.background=`url('${profile.avatar}')`;
document.getElementById("avatar").innerText="";
}else{
document.getElementById("avatar").innerText=profile.username.charAt(0).toUpperCase();
}

document.getElementById("bgColor").value=profile.bg_color||"#ffffff";
document.getElementById("textColor").value=profile.text_color||"#111111";
document.getElementById("btnColor").value=profile.button_color||"#ffffff";
document.getElementById("fontSelect").value=profile.font||"default";

applyDesign(profile);
loadLinks();
}

function applyDesign(profile){
const card=document.getElementById("previewCard");
card.style.background=profile.bg_color||"#fff";
card.style.color=profile.text_color||"#111";
if(profile.font==="serif")card.style.fontFamily="serif";
if(profile.font==="mono")card.style.fontFamily="monospace";
if(profile.font==="modern")card.style.fontFamily="Inter,sans-serif";
}

async function saveBio(){
const bio=document.getElementById("bioInput").value;
await supabaseClient.from("profiles").update({bio:bio}).eq("id",userId);
load();
}

async function addLink(){
const title=document.getElementById("title").value;
const url=document.getElementById("url").value;
if(!title||!url)return;

await supabaseClient.from("links").insert([
{user_id:userId,title:title,url:url,featured:false,position:Date.now()}
]);

document.getElementById("title").value="";
document.getElementById("url").value="";
loadLinks();
}

async function setFeatured(id){
await supabaseClient.from("links").update({featured:false}).eq("user_id",userId);
await supabaseClient.from("links").update({featured:true}).eq("id",id);
loadLinks();
}

async function loadLinks(){
const {data}=await supabaseClient
.from("links")
.select("*")
.eq("user_id",userId)
.order("featured",{ascending:false})
.order("position",{ascending:true});

linksData=data;

renderLinks();
renderPreview();
enableDrag();
}

function renderLinks(){
let html="";
let clicksHtml="";
linksData.forEach(l=>{
html+=`
<div class="linkRow" draggable="true" data-id="${l.id}">
<div>${l.title} ${l.featured?'‚≠ê':''}</div>
<div><button onclick="setFeatured('${l.id}')">‚≠ê</button></div>
</div>
`;
clicksHtml+=`<div class="statBox" style="background:#111">${l.title} ‚Üí ${l.clicks||0} clicks</div>`;
});
document.getElementById("linksList").innerHTML=html;
document.getElementById("clickStats").innerHTML=clicksHtml;
}

function renderPreview(){
let html="";
linksData.forEach(l=>{
if(l.featured){
html+=`<a class="linkbtn featured">${l.title}</a>`;
}else{
html+=`<a class="linkbtn">${l.title}</a>`;
}
});
document.getElementById("previewLinks").innerHTML=html;
}

function enableDrag(){
const draggables=document.querySelectorAll(".linkRow");
const container=document.getElementById("linksList");

draggables.forEach(d=>{
d.addEventListener("dragstart",()=>d.classList.add("dragging"));
d.addEventListener("dragend",()=>{
d.classList.remove("dragging");
saveOrder();
});
});

container.addEventListener("dragover",e=>{
e.preventDefault();
const after=getAfter(container,e.clientY);
const dragging=document.querySelector(".dragging");
if(!dragging)return;
if(after==null)container.appendChild(dragging);
else container.insertBefore(dragging,after);
});
}

function getAfter(container,y){
const els=[...container.querySelectorAll(".linkRow:not(.dragging)")];
return els.reduce((closest,child)=>{
const box=child.getBoundingClientRect();
const offset=y-box.top-box.height/2;
if(offset<0 && offset>closest.offset){
return{offset:offset,element:child};
}else return closest;
},{offset:Number.NEGATIVE_INFINITY}).element;
}

async function saveOrder(){
const rows=document.querySelectorAll(".linkRow");
let pos=1;
for(const r of rows){
const id=r.getAttribute("data-id");
await supabaseClient.from("links").update({position:pos}).eq("id",id);
pos++;
}
loadLinks();
}

async function saveDesign(){
const bg=document.getElementById("bgColor").value;
const text=document.getElementById("textColor").value;
const btn=document.getElementById("btnColor").value;
const font=document.getElementById("fontSelect").value;

await supabaseClient.from("profiles")
.update({bg_color:bg,text_color:text,button_color:btn,font:font})
.eq("id",userId);

load();
}

load();
</script>

</body>
</html>
